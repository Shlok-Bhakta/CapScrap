<%= turbo_frame_tag "rentings_table" do %>
  <div class="flex flex-col">
    <table class="w-full">
      <thead>
        <tr class="border-b">
          <th class="p-2 text-left text-content" data-font-size="16">
            <%= sort_rentings_header('user', 'User', sort_field, sort_direction) %>
          </th>
          <th class="p-2 text-left text-content" data-font-size="16">
            <%= sort_rentings_header('item', 'Item', sort_field, sort_direction) %>
          </th>
          <th class="p-2 text-left w-1/6 text-content" data-font-size="16">
            <%= sort_rentings_header('quantity', 'Quantity', sort_field, sort_direction) %>
          </th>
          <th class="p-2 text-left text-content" data-font-size="16">
            <%= sort_rentings_header('checkout_date', 'Checkout Date', sort_field, sort_direction) %>
          </th>
          <th class="p-2 text-left text-content" data-font-size="16">
            <%= sort_rentings_header('return_date', 'Return Date', sort_field, sort_direction) %>
          </th>
          <th class="p-2 text-left text-content" data-font-size="16">Status</th>
          <th class="p-2 text-left text-content" data-font-size="16">Single Use</th>
          <th class="p-2 text-left text-content" data-font-size="16">Comments</th>
          <th class="p-2 text-left text-content" data-font-size="16">Actions</th>
        </tr>
      </thead>
      <tbody>
      <% rentings.each do |renting| %>
        <tr id="renting_<%= renting.id %>" class="border-b hover:bg-gray-50">
          <td class="p-2 text-content" data-font-size="16"><%= renting.user.email %></td>
          <td class="p-2 text-content" data-font-size="16"><%= renting.item.description %></td>
          <td class="p-2 text-content" data-font-size="16"><%= renting.quantity %></td>
          <td class="p-2 text-content" data-font-size="16"><%= renting.checkout_date&.strftime("%Y-%m-%d") %></td>
          <td class="p-2 text-content" data-font-size="16"><%= renting.return_date&.strftime("%Y-%m-%d") %></td>
          <td class="p-2 text-content" data-font-size="16">
            <%= form_with(url: admin_dashboard_toggle_renting_path(id: renting.id), 
                         method: :patch,
                         data: { turbo_stream: true, 
                                turbo_confirm: "Are you sure you want to change this item's status?" }) do |f| %>
              <%= f.button renting.is_returned ? 'Returned' : 'Rented',
                          class: renting.is_returned ? 'px-2 py-1 bg-confirm text-text rounded' : 'px-2 py-1 bg-secondary text-text rounded',
                          data: { disable_with: "Updating..." } %>
            <% end %>
          </td>
          <td class="p-2 text-content" data-font-size="16">
            <%= form_with(url: admin_dashboard_toggle_singleuse_path(id: renting.id), 
                         method: :patch,
                         data: { turbo_stream: true, 
                                turbo_confirm: "Are you sure you want to change this item's status?" }) do |f| %>
              <%= f.button renting.is_singleuse ? 'Yes' : 'No',
                          class: renting.is_singleuse ? 'px-2 py-1 bg-confirm text-text rounded' : 'px-2 py-1 bg-secondary text-text rounded',
                          data: { disable_with: "Updating..." } %>
            <% end %>
          </td>


          <td class="p-2 text-content" data-font-size="16">
            <div class="flex justify-center">
              <button type="button" 
                    class="text-blue-600 hover:text-blue-800" 
                    data-renting-id="<%= renting.id %>"
                    onclick="document.getElementById('comment-modal-<%= renting.id %>').classList.remove('hidden'); document.getElementById('comment-modal-<%= renting.id %>').classList.add('flex')"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
            </div>
            <div
              id="comment-modal-<%= renting.id %>"
              class="fixed inset-0 z-50 items-center justify-center backdrop-blur-sm hidden"
            >
              <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-4 relative">
                <button
                  type="button"
                  class="absolute top-2 right-2 text-gray-500 hover:text-black"
                  onclick="
                            const modal = document.getElementById('comment-modal-<%= renting.id %>');
                            const textarea = modal.querySelector('textarea');
                            textarea.value = textarea.getAttribute('data-original-value');
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                  "
                >
                  &times;
                </button>

                <h2 class="text-lg font-semibold mb-2">Comments</h2>
                <div class="flex flex-col">
                  <%= form_with(url: admin_dashboard_add_comment_path(id: renting.id), method: :post, data: { turbo_stream: true }, html: { id: "comment-form-#{renting.id}", onsubmit: "setTimeout(() => window.location.reload(), 100);" }) do |f| %>
                    <div class="mb-4">
                      <%= f.text_area :comment,
                                      value: renting.comments || "" ,
                                      data: { "original-value": renting.comments || ""  },
                                      rows: 6,
                                      class: "w-full p-2 border rounded",
                                      placeholder: "Add or edit comment..." %>
                    </div>
                    <div class="flex justify-end space-x-2">
                      <button
                        type="button"
                        class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-black"
                        onclick="
                            const modal = document.getElementById('comment-modal-<%= renting.id %>');
                            const textarea = modal.querySelector('textarea');
                            textarea.value = textarea.getAttribute('data-original-value');
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                        "
                      >
                        Cancel
                      </button>
                      <%= f.submit "Save", class: "px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded", data: { disable_with: "Saving..." } %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </td>
          <td class="p-2 text-content" data-font-size="16">
            <%= form_with(url: admin_dashboard_delete_renting_path(id: renting.id), 
                        method: :delete,
                         data: { turbo_stream: true, 
                                turbo_confirm: "Are you sure you want to delete this renting?" }) do |f| %> 
              <%= f.button "Delete",
                          class: "px-2 py-1 bg-red-500 hover:bg-red-700 text-white rounded",
                          data: { disable_with: "Deleting..." } %>
            <% end %>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
    
    <% if rentings.any? %>
      <%= pagination_nav(pagy) %>
    <% else %>
      <p class="text-center text-gray-500 mt-4 text-content" data-font-size="16">No rentings found</p>
    <% end %>
  </div>
<% end %>

<script>
  document.addEventListener("turbo:submit-end", function(event) {
    const form = event.target;

    if (form.id && form.id.startsWith("comment-form-")) {
      const modalId = "comment-modal-" + form.id.split("comment-form-")[1];
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add("hidden");
      }
    }
  });
</script>